<html xmlns:th="https://www.thymeleaf.org"
        th:replace="ej13/layout::plantilla( ~{::body})">
    <head>
        <title>Titulo</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="registroFacturas" class="row justify-content-center ">
            <div class="col-12">
                <a href="/ejercicio13" class="btn btn-primary col-4" >Volver al Inicio</a>
            </div>
            <form action="/ejercicio13/guardarFactura" th:object="${factura}" method="post">
                <div class="form-group row">
                    <div class="col-6">
                        <label for="url">Nº de Factura</label>
                        <input readonly th:field="*{idFactura}" class="form-control text-right" type="text" />
                    </div>
                    <div class="col-6">
                        <label for="fecha">Fecha</label>
                        <input th:value="${#dates.format(factura.fecha, 'dd/MM/yyyy')}" name="fecha" type="text" class="form-control text-right">
                    </div>
                </div>
                <div class="form-group row">
                    <div class="col-6">
                        <label for="nombre">Nombre</label>
                        <input class="form-control" th:field="*{nombre}" type="text" required />
                    </div>
                    <div class="col-6">
                        <label for="direccion">Direccion</label>
                        <input class="form-control" th:field="*{direccion}" type="text" required />
                    </div>
                    
                </div>
                <div class="form-group row">
                    <div class="col-6">
                        <label for="nif">NIF</label>
                        <input class="form-control" th:field="*{nif}" type="text" required />
                    </div>
                    <div class="col-4">
                        <input class="btn btn-success" type="submit" value="Guardar factura" />
                    </div>
                </div>
            </form>
        </div>
        <hr />
        <th:block th:if="${detalles==null}">
            <div class="text-center">
                <button onclick="addDet()" class="btn btn-info" >Añadir</button>
            </div>
        </th:block>
        <div id="listaDetalles" class="row justify-content-center ">  
            <table style="width:85%" class="table table-striped table-bordered" th:if="${detalles!=null}">
                <tr>
                    <th>CANT.</th>
                    <th>DESCRIPCION</th>
                    <th>IMPORTE</th>
                </tr>
                <tr th:each="fa:${detalles}">
                    <td th:text="${fa.cantidad}"></td>
                    <td th:text="${fa.descripcion}"></td>
                    <td th:text="${fa.importe}"></td>
                    <td>
                        <button th:attr="onclick=|editor('${factura.idFactura}','${fa.idDetalle}')|" class="btn btn-info" >Editar</button>
                        <a th:href="|/ejercicio13/borrarDetalle?idDetalle=${fa.idDetalle}|" class="btn btn-danger" >Borrar</a>
                    </td>
                </tr>
                <tr>
                    <td class="text-center" colspan="2">
                        <button onclick="addDet()" class="btn btn-info" >Añadir</button>
                    </td>
                    <td class="text-center" colspan="1">
                        Total: <strong th:text="${total}"></strong>
                    </td>
                </tr>
            </table>
        </div>


        <!-- Formulario modal para añadir y editar detalles -->
        <div id="detalles" style="display:none">
            <form action="/ejercicio13/guardarDetalles" th:object="${nueva}" method="post">
                <input type="hidden" name="idFactura" th:value="${factura.idFactura}" />
                <input th:if="${nueva.idDetalle!=null}" th:field="*{idDetalle}" type="hidden"  />
                <div class="form-group row">
                    <div class="col-6">
                        <label for="cantidad">Cantidad</label>
                        <input th:field="*{cantidad}" class="form-control" min="1" type="number" />
                    </div>
                    <div class="col-6">
                        <label for="descripcion">Descripcion</label>
                        <input class="form-control" th:field="*{descripcion}" type="text" required />
                    </div>   
                </div>
                <div class="form-group row">
                    <div class="col-6">
                        <label for="importe">Importe</label>
                        <input step=".01" class="form-control" th:field="*{importe}" min="1" type="number" required />
                    </div>
                    <div class="col-4">
                        <input class="btn btn-success" type="submit" value="Guardar factura" />
                    </div>
                </div>
            </form>
        </div>
        <script>
            function addDet() {
                bootbox.dialog({
                    title: "Añadir factura",
                    message: $('#detalles').html(),
                });
            };
            function editor(id,detalle){
                var href = detalle;
                console.log(href);
                location.href = "/ejercicio13/editarFactura?id=" + id + "&idDetalle=" +detalle;
            }   
        </script>
    </body>
</html>
