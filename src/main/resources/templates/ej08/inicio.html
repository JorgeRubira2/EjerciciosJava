<!doctype html>
<html >
    <head>
        <title>Titulo</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
        <style>
            .rojo{
                color:red;
            }
            .verde{
                color:green;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <table id="bolsa" class="table table-hover"></table>
        </div>

        <div id="formularioComprar" style="display:none">
            <form action="/ejercicio8/compra" method="post">
                <input type="datetime-local" name="hora" readonly/>
                <input type="text" name="titulo" readonly/>
                <input type="radio" name="operacion" value="comprar"/>
                <input type="radio" name="operacion" value="vender"/>
                <input type="number" name="titulos"/>
                <input type="number" name="precio" readonly/>
                <input type="submit" value="Guardar">
            </form>

        </div>




        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.js"></script> 
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery-deserialize@2.0.0-rc1/src/jquery.deserialize.min.js"></script> 
        <!-- titulo, ultimo, variacion, variacionPorcentaje, volumen, maximo, minimo, hora -->
        <script>
            $(document).ready(function(){
            refrescar();
            });
                    function cargarDatos(){
                    $.ajax({
                    url:'ejercicio8/listaCotizaciones',
                            datatype:'json',
                            success: function(json){
                            $("#bolsa").html("");
                                    $("#bolsa").append("<thead><tr><th>Empresa</th><th>Útimo valor</th><th>Variación</th>" +
                                    "<th>Porcentaje</th><th>Volumen</th><th>max</th><th>min</th><th>Hora</th><th>Acciones</th></tr></thead>");
                                    $.each(json, function(key, value){
                                    var fila = $("<tr>");
                                            var titulo = value.titulo;
                                            var hora = value.hora;
                                            var precio = value.ultimo;
                                            var color = value.variacion > 0?"verde":value.variacion < 0?"rojo":"";
                                            var flecha = value.variacion > 0?"<i class='fas fa-sort-up'></i>":value.variacion < 0?"<i class='fas fa-sort-down'></i>":"";
                                            $("<td>").html(value.titulo + "</td>").appendTo(fila);
                                            $("<td>").html(value.ultimo + "</td>").appendTo(fila);
                                            $("<td>").attr("class", color).html(value.variacion + " " + flecha + "</td>").appendTo(fila);
                                            $("<td>").attr("class", color).html(value.variacionPorcentaje + "% " + flecha + "</td>").appendTo(fila);
                                            $("<td>").html(value.volumen + "</td>").appendTo(fila);
                                            $("<td>").html(value.maximo + "</td>").appendTo(fila);
                                            $("<td>").html(value.minimo + "</td>").appendTo(fila);
                                            $("<td>").html(value.hora + "</td>").appendTo(fila);
                                            $("<td>").html("<input type='button' value='Acciones' class='btn btn-primary' onClick='accion(`" + titulo + "`," + precio + ",`" + hora + "`);'/></td>").appendTo(fila);
                                            fila.append("</tr>");
                                            fila.appendTo("#bolsa");
                                    });
                                    $("#bolsa").append("</table>");
                            }
                    });
                    }
            function refrescar(){
            cargarDatos();
                    setInterval(function(){refrescar(); }, 30000);
            }
            function accion(pTitulo, pPrecio, pHora){
            $("form").submit(function (event) {
                                var formData = {
                                name: $("#name").val(),
                                email: $("#email").val(),
                                superheroAlias: $("#superheroAlias").val()
                                }});
            
            $.ajax({
            type: "POST",
                    url: "/ejercicio8/formulario",
                    data: {
                    titulo: pTitulo,
                            precio: pPrecio,
                            hora:pHora
                    },
                    dataType: "json",
                    success: function (pJson) {
                    bootbox.dialog({
                    title:'Comprar',
                            message: "<div id='formBB'>" + $('#formularioComprar').html() + "</div>"
                    });
                            $('#formBB form').deserialize(pJson);
                    },
                    error: function (err) {
                    alert('Si la URL esta mal. Codigo 404')
                    }
            })
            }
        </script>
    </body>
</html>
